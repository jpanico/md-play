"""Tests for the roam_node_fetch module."""

import json
import logging
import os
import pathlib
from unittest.mock import MagicMock, patch

import pytest
import requests
import yaml
from pydantic import ValidationError
from roam_pub.roam_local_api import ApiEndpoint, ApiEndpointURL
from roam_pub.roam_types import IdObject
from roam_pub.roam_node import RoamNode
from roam_pub.roam_node_fetch import FetchRoamNodes

_FIXTURES_YAML_DIR = pathlib.Path(__file__).parent / "fixtures" / "yaml"

logger = logging.getLogger(__name__)


@pytest.fixture
def api_endpoint() -> ApiEndpoint:
    """Return a minimal ApiEndpoint for use in unit tests."""
    return ApiEndpoint(
        url=ApiEndpointURL(local_api_port=3333, graph_name="test-graph"),
        bearer_token="test-token",
    )


@pytest.fixture
def mock_200_response() -> MagicMock:
    """Return a mock requests.Response with status 200 and a minimal page body."""
    mock: MagicMock = MagicMock()
    mock.status_code = 200
    mock.text = json.dumps(
        {
            "success": True,
            "result": [[{"title": "My Page", "uid": "abc123xyz", "id": 1, "time": 1700000000000, "user": {"id": 3}}]],
        }
    )
    return mock


class TestFetchRoamNodesInstantiation:
    """Tests that FetchRoamNodes cannot be instantiated."""

    def test_instantiation_raises_type_error(self) -> None:
        """Test that instantiating FetchRoamNodes raises TypeError."""
        with pytest.raises(TypeError, match="stateless utility class"):
            FetchRoamNodes()


class TestFetchRoamNodesRequest:
    """Tests for FetchRoamNodes.Request constants and payload factory."""

    def test_datalog_page_query_is_non_empty(self) -> None:
        """Test that BY_PAGE_TITLE_QUERY is a non-empty string."""
        assert isinstance(FetchRoamNodes.Request.BY_PAGE_TITLE_QUERY, str)
        assert len(FetchRoamNodes.Request.BY_PAGE_TITLE_QUERY) > 0

    def test_datalog_page_query_contains_find_clause(self) -> None:
        """Test that BY_PAGE_TITLE_QUERY contains a :find clause."""
        assert ":find" in FetchRoamNodes.Request.BY_PAGE_TITLE_QUERY

    def test_datalog_page_query_contains_node_title(self) -> None:
        """Test that BY_PAGE_TITLE_QUERY filters by :node/title."""
        assert ":node/title" in FetchRoamNodes.Request.BY_PAGE_TITLE_QUERY

    def test_payload_action_is_data_q(self) -> None:
        """Test that payload_by_page_title() produces action 'data.q'."""
        assert FetchRoamNodes.Request.payload_by_page_title("Any Page").action == "data.q"

    def test_payload_args_contains_query(self) -> None:
        """Test that payload_by_page_title() includes the Datalog query string in args."""
        assert (
            FetchRoamNodes.Request.BY_PAGE_TITLE_QUERY in FetchRoamNodes.Request.payload_by_page_title("Any Page").args
        )

    def test_payload_args_contains_page_title(self) -> None:
        """Test that payload_by_page_title() includes the page title in args."""
        assert "My Page" in FetchRoamNodes.Request.payload_by_page_title("My Page").args


class TestFetchRoamNodesResponsePayload:
    """Tests for FetchRoamNodes.Response.Payload validation."""

    def test_valid_construction(self) -> None:
        """Test that a valid Payload can be constructed."""
        payload: FetchRoamNodes.Response.Payload = FetchRoamNodes.Response.Payload(
            success=True,
            result=[[RoamNode(uid="abc123xyz", id=1, time=1700000000000, user=IdObject(id=3), title="My Page")]],
        )

        assert payload.success is True
        assert len(payload.result) == 1
        assert payload.result[0][0].uid == "abc123xyz"

    def test_null_raises_validation_error(self) -> None:
        """Test that model_validate(None) raises ValidationError."""
        with pytest.raises(ValidationError):
            FetchRoamNodes.Response.Payload.model_validate(None)

    def test_valid_result_parses_correctly(self) -> None:
        """Test that a nested result dict is parsed into a list[list[RoamNode]]."""
        raw: dict[str, object] = {
            "success": True,
            "result": [[{"title": "My Page", "uid": "abc123xyz", "id": 1, "time": 1700000000000, "user": {"id": 3}}]],
        }

        payload: FetchRoamNodes.Response.Payload = FetchRoamNodes.Response.Payload.model_validate(raw)

        assert payload.success is True
        assert len(payload.result) == 1
        node: RoamNode = payload.result[0][0]
        assert node.uid == "abc123xyz"
        assert node.title == "My Page"
        assert node.time == 1700000000000

    def test_empty_result_is_valid(self) -> None:
        """Test that an empty result list (page not found) is valid."""
        payload: FetchRoamNodes.Response.Payload = FetchRoamNodes.Response.Payload.model_validate(
            {"success": True, "result": []}
        )

        assert payload.result == []

    def test_missing_success_key_raises_error(self) -> None:
        """Test that a missing 'success' key raises ValidationError."""
        with pytest.raises(ValidationError):
            FetchRoamNodes.Response.Payload.model_validate({"result": [[{"uid": "abc123xyz", "title": "My Page"}]]})

    def test_missing_result_key_raises_error(self) -> None:
        """Test that a missing 'result' key raises ValidationError."""
        with pytest.raises(ValidationError):
            FetchRoamNodes.Response.Payload.model_validate({"success": True})

    def test_missing_uid_in_result_node_raises_error(self) -> None:
        """Test that a result node dict missing 'uid' raises ValidationError."""
        with pytest.raises(ValidationError):
            FetchRoamNodes.Response.Payload.model_validate({"success": True, "result": [[{"title": "My Page"}]]})

    def test_immutability(self) -> None:
        """Test that Payload instances are immutable (frozen)."""
        payload: FetchRoamNodes.Response.Payload = FetchRoamNodes.Response.Payload(
            success=True,
            result=[],
        )
        with pytest.raises(Exception):
            payload.success = False  # type: ignore[misc]


class TestFetchRoamNodesFetch:
    """Tests for FetchRoamNodes.fetch_by_page_title."""

    def test_null_api_endpoint_raises_validation_error(self) -> None:
        """Test that None api_endpoint raises ValidationError."""
        with pytest.raises(ValidationError):
            FetchRoamNodes.fetch_by_page_title(page_title="My Page", api_endpoint=None)  # type: ignore[arg-type]

    def test_null_page_title_raises_validation_error(self, api_endpoint: ApiEndpoint) -> None:
        """Test that None page_title raises ValidationError."""
        with pytest.raises(ValidationError):
            FetchRoamNodes.fetch_by_page_title(page_title=None, api_endpoint=api_endpoint)  # type: ignore[arg-type]

    def test_http_error_response_raises_http_error(self, api_endpoint: ApiEndpoint) -> None:
        """Test that a non-200 HTTP response raises requests.exceptions.HTTPError."""
        mock_response: MagicMock = MagicMock()
        mock_response.status_code = 500
        mock_response.text = "Internal Server Error"

        with patch("roam_pub.roam_local_api.requests.post", return_value=mock_response):
            with pytest.raises(requests.exceptions.HTTPError):
                FetchRoamNodes.fetch_by_page_title(page_title="My Page", api_endpoint=api_endpoint)

    def test_successful_fetch_returns_roam_nodes(self, api_endpoint: ApiEndpoint, mock_200_response: MagicMock) -> None:
        """Test that a successful HTTP 200 response returns a list of RoamNodes."""
        with patch("roam_pub.roam_local_api.requests.post", return_value=mock_200_response):
            nodes: list[RoamNode] = FetchRoamNodes.fetch_by_page_title(page_title="My Page", api_endpoint=api_endpoint)

        assert len(nodes) == 1
        assert nodes[0].title == "My Page"
        assert nodes[0].uid == "abc123xyz"

    def test_page_not_found_returns_empty_list(self, api_endpoint: ApiEndpoint) -> None:
        """Test that an empty result (page not found) returns an empty list."""
        mock_response: MagicMock = MagicMock()
        mock_response.status_code = 200
        mock_response.text = json.dumps({"success": True, "result": []})

        with patch("roam_pub.roam_local_api.requests.post", return_value=mock_response):
            nodes: list[RoamNode] = FetchRoamNodes.fetch_by_page_title(
                page_title="Nonexistent", api_endpoint=api_endpoint
            )

        assert nodes == []

    def test_posts_to_correct_endpoint_url(self, api_endpoint: ApiEndpoint, mock_200_response: MagicMock) -> None:
        """Test that the POST is made to the correct endpoint URL."""
        with patch("roam_pub.roam_local_api.requests.post", return_value=mock_200_response) as mock_post:
            FetchRoamNodes.fetch_by_page_title(page_title="My Page", api_endpoint=api_endpoint)

        assert mock_post.call_args.args[0] == str(api_endpoint.url)

    def test_posts_data_q_action(self, api_endpoint: ApiEndpoint, mock_200_response: MagicMock) -> None:
        """Test that the POST body contains the data.q action."""
        with patch("roam_pub.roam_local_api.requests.post", return_value=mock_200_response) as mock_post:
            FetchRoamNodes.fetch_by_page_title(page_title="My Page", api_endpoint=api_endpoint)

        posted_json: dict[str, object] = mock_post.call_args.kwargs["json"]
        assert posted_json["action"] == "data.q"

    def test_posts_page_title_in_args(self, api_endpoint: ApiEndpoint, mock_200_response: MagicMock) -> None:
        """Test that the POST body includes the page title in args."""
        with patch("roam_pub.roam_local_api.requests.post", return_value=mock_200_response) as mock_post:
            FetchRoamNodes.fetch_by_page_title(page_title="My Page", api_endpoint=api_endpoint)

        posted_json: dict[str, object] = mock_post.call_args.kwargs["json"]
        assert "My Page" in posted_json["args"]  # type: ignore[operator]

    def test_bearer_token_in_request_headers(self, mock_200_response: MagicMock) -> None:
        """Test that the bearer token is correctly placed in the Authorization header."""
        token_endpoint: ApiEndpoint = ApiEndpoint.from_parts(
            local_api_port=3333,
            graph_name="test-graph",
            bearer_token="my-secret-token",
        )

        with patch("roam_pub.roam_local_api.requests.post", return_value=mock_200_response) as mock_post:
            FetchRoamNodes.fetch_by_page_title(page_title="My Page", api_endpoint=token_endpoint)

        headers: dict[str, object] = mock_post.call_args.kwargs["headers"]
        assert headers["Authorization"] == "Bearer my-secret-token"

    def test_node_attributes_preserved(self, api_endpoint: ApiEndpoint) -> None:
        """Test that extra RoamNode fields (time, children) survive the HTTP round-trip."""
        mock_response: MagicMock = MagicMock()
        mock_response.status_code = 200
        mock_response.text = json.dumps(
            {
                "success": True,
                "result": [
                    [
                        {
                            "title": "Rich Page",
                            "uid": "rich1234x",
                            "id": 2,
                            "time": 1700000000000,
                            "user": {"id": 3},
                            "children": [{"id": 42}],
                        }
                    ]
                ],
            }
        )

        with patch("roam_pub.roam_local_api.requests.post", return_value=mock_response):
            nodes: list[RoamNode] = FetchRoamNodes.fetch_by_page_title(
                page_title="Rich Page", api_endpoint=api_endpoint
            )

        assert len(nodes) == 1
        assert nodes[0].time == 1700000000000
        assert nodes[0].children == [IdObject(id=42)]

    @pytest.mark.live
    @pytest.mark.skipif(not os.getenv("ROAM_LIVE_TESTS"), reason="requires Roam Desktop app running locally")
    def test_fetch_testarticle(self) -> None:
        """Live test: fetch all descendant blocks of a page and compare with fixture."""
        live_endpoint: ApiEndpoint = ApiEndpoint.from_parts(
            local_api_port=int(os.environ["ROAM_LOCAL_API_PORT"]),
            graph_name=os.environ["ROAM_GRAPH_NAME"],
            bearer_token=os.environ["ROAM_API_TOKEN"],
        )
        page_title = "Test Article"

        nodes: list[RoamNode] = FetchRoamNodes.fetch_by_page_title(page_title=page_title, api_endpoint=live_endpoint)
        logger.debug("nodes: %s", nodes)

        fixture_nodes: list[RoamNode] = [
            RoamNode.model_validate(raw)
            for raw in yaml.safe_load((_FIXTURES_YAML_DIR / "test_article_nodes.yaml").read_text())
        ]

        assert sorted(nodes, key=lambda n: n.uid) == sorted(fixture_nodes, key=lambda n: n.uid)
